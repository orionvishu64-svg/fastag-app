<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UPI Payment — Complete Payment</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; color: #222; }
    .info { margin: 12px 0; color: #333; }
    .status { margin-top: 16px; font-weight: 700; }
    .small { font-size: 0.9rem; color: #666; }
    button { background:#6a00ff;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer; }
    a.fallback { display:inline-block;margin-top:8px; color:#0645ad; word-break:break-all; }
    .hidden { display:none; }
    .qr { margin-top:12px; }
    .badge { display:inline-block;padding:6px 10px;border-radius:12px;background:#ffdd57;color:#111;font-weight:600 }
  </style>
</head>
<body>
  <h2>Complete Payment</h2>

  <div class="info">
    <div>Amount: <strong id="amountText">—</strong></div>
    <div>Order ID: <strong id="orderText">—</strong></div>
    <div>Txn Ref: <strong id="txnText">—</strong></div>
    <div style="margin-top:8px;">
      Status: <span id="status" class="status"><span class="badge">Preparing...</span></span>
    </div>
    <div class="small" style="margin-top:8px">Your order remains in <strong>Pending / Not verified</strong> until payment is confirmed by server/webhook or admin.</div>
  </div>

  <div style="margin-top:12px;">
    <button id="openBtn" type="button">Open UPI App</button>
    <button id="copyBtn" type="button" style="margin-left:8px;">Copy UPI String</button>
  </div>

  <a id="upiManual" class="fallback hidden" href="#" target="_blank">Open UPI (manual)</a>

  <div id="qrWrap" class="qr hidden">
    <p class="small">Scan with another phone:</p>
    <img id="qrImg" alt="UPI QR">
  </div>

<script>
(async function () {
  // === CONFIG ===
  const MERCHANT_VPA = 'apnapaymentbbps@yesbank';
  const MERCHANT_NAME = 'ApnaPayment';
  const NOTE_DEFAULT = 'Tag Payment';
  // ==============

  const params = new URLSearchParams(location.search);
  const rawAmount = params.get('amount') || '';
  const addressId = params.get('address_id') || '';
  const orderIdFromQS = params.get('order_id') || '';

  const amountNum = Number(rawAmount);
  const amount = (!isNaN(amountNum) && amountNum > 0) ? amountNum.toFixed(2) : null;
  if (!amount) {
    document.getElementById('status').innerHTML = '<span class="badge" style="background:#e74c3c;color:#fff">Invalid amount</span>';
    return;
  }

  document.getElementById('amountText').textContent = amount;

  document.getElementById('status').innerHTML = '<span class="badge">Creating order...</span>';
  let orderId = orderIdFromQS || null;
  let txnRef = null;

  try {
    if (!orderId) {
      const body = new URLSearchParams();
      body.append('amount', amount);
      if (addressId) body.append('address_id', addressId);
      body.append('payment_method', 'upi');

      const res = await fetch('place_order.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
      });
      const data = await res.json();
      if (!data || !data.success) throw new Error(data && data.error ? data.error : 'place_order failed');
      orderId = data.order_id || data.id || null;
      txnRef = data.txnRef || data.transaction_id || null;
    } else {
      const res = await fetch('place_order.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ order_id: orderId, amount: amount, payment_method: 'upi' }).toString()
      });
      const data = await res.json();
      if (data && data.success) txnRef = data.txnRef || data.transaction_id || null;
    }

    if (!txnRef) {
      txnRef = 'TXN' + Date.now();
      console.warn('No txnRef from server; using fallback:', txnRef);
    }

    document.getElementById('orderText').textContent = orderId || '—';
    document.getElementById('txnText').textContent = txnRef;
    document.getElementById('status').innerHTML = '<span class="badge" style="background:#ffdd57;color:#111">Pending / Not verified</span>';
  } catch (err) {
    document.getElementById('status').innerHTML = '<span class="badge" style="background:#e74c3c;color:#fff">Create order failed</span>';
    console.error(err);
    return;
  }

  // build UPI strings
  const tn = encodeURIComponent(NOTE_DEFAULT);
  const encodedPa = encodeURIComponent(MERCHANT_VPA);
  const encodedPn = encodeURIComponent(MERCHANT_NAME);
  const encodedTr = encodeURIComponent(txnRef);
  const encodedAm = encodeURIComponent(amount);

  const intentUrl = `intent://upi/pay?pa=${encodedPa}&pn=${encodedPn}&am=${encodedAm}&tn=${tn}&tr=${encodedTr}#Intent;scheme=upi;end`;
  const upiUrl = `upi://pay?pa=${encodedPa}&pn=${encodedPn}&am=${encodedAm}&tn=${tn}&tr=${encodedTr}&cu=INR`;

  const manualEl = document.getElementById('upiManual');
  manualEl.href = upiUrl;
  manualEl.textContent = 'Open UPI (manual) — ' + upiUrl;

  function showQr(text) {
    const qrWrap = document.getElementById('qrWrap');
    const qrImg = document.getElementById('qrImg');
    qrImg.src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(text);
    qrWrap.classList.remove('hidden');
  }

  document.getElementById('copyBtn').addEventListener('click', function () {
    navigator.clipboard.writeText(upiUrl).then(function () {
      document.getElementById('status').innerHTML = '<span class="badge" style="background:#ffdd57;color:#111">Pending / Not verified</span>';
      manualEl.classList.remove('hidden');
      showQr(upiUrl);
    }, function () {
      manualEl.classList.remove('hidden');
      showQr(upiUrl);
      window.prompt('Copy the UPI string below (Ctrl+C / long-press):', upiUrl);
      document.getElementById('status').innerHTML = '<span class="badge" style="background:#ffdd57;color:#111">Pending / Not verified</span>';
    });
  });

  // open UPI app
  function openUpi() {
    document.getElementById('status').innerHTML = '<span class="badge" style="background:#ffdd57;color:#111">Pending / Not verified</span>';
    const ua = navigator.userAgent || '';
    if (/Android/i.test(ua)) {
      try { window.location.href = intentUrl; } catch (e) {}
      setTimeout(function () { try { window.location.href = upiUrl; } catch (e) {} }, 800);
    } else {
      try { window.location.href = upiUrl; } catch (e) {}
      manualEl.classList.remove('hidden');
      showQr(upiUrl);
    }
  }

  document.getElementById('openBtn').addEventListener('click', openUpi);

  setTimeout(openUpi, 500);

})();
</script>
</body>
</html>