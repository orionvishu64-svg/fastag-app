<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Forgot mPIN</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        min-height: 100vh;
        background-color: #f4f6f8;
      }
      .auth-card {
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      }
      .form-label {
        font-weight: 500;
        color: #555;
      }
      .form-control {
        border-radius: 10px;
      }
      .form-control:focus {
        border-color: #ffb84d;
        box-shadow: 0 0 0 0.2rem rgba(255, 184, 77, 0.25);
      }
      .btn-primary {
        background: linear-gradient(90deg, #ffb84d, #e85c41);
        border: none;
        color: #111;
        font-weight: 700;
      }
      .btn-primary:hover {
        filter: brightness(1.05);
      }
      .btn-outline-warning {
        border-color: #ffb84d;
        color: #e85c41;
      }
      .btn-outline-warning:hover {
        background-color: #ffb84d;
        color: #111;
      }
      .toggle-btn {
        font-size: 13px;
        color: #e85c41;
        background: none;
        border: none;
        cursor: pointer;
      }
      .ok {
        display: none;
        color: #22c55e;
        font-weight: 600;
      }
      .err {
        color: #b00020;
        font-size: 0.9rem;
        min-height: 18px;
      }
    </style>
  </head>

  <body class="d-flex align-items-center justify-content-center p-3">
    <div class="container" style="max-width: 520px">
      <!-- Logo -->
      <div class="text-center mb-4">
        <img
          src="https://www.apnapayment.com/website/img/logo/ApnaPayment200Black.png"
          alt="ApnaPayment"
          class="img-fluid"
          style="max-width: 180px"
        />
      </div>

      <!-- Card -->
      <div class="auth-card p-4 p-md-5">
        <h4 class="text-center fw-bold mb-2">Reset Your mPIN</h4>
        <p class="text-center text-muted mb-4">
          We’ll verify your phone number and help you set a new mPIN.
        </p>

        <!-- STEP 1 -->
        <div id="step1">
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input
              id="phone"
              class="form-control"
              inputmode="numeric"
              maxlength="10"
              placeholder="Enter 10-digit phone number"
              required
            />
          </div>

          <div class="d-flex justify-content-end mb-2">
            <button id="send" type="button" class="btn btn-outline-warning">
              Send OTP
            </button>
          </div>

          <div id="msg" class="err mb-2"></div>

          <div class="text-center">
            <a href="index.html" class="small text-decoration-none">
              Remembered your mPIN? Back to Login
            </a>
          </div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" style="display: none" class="mt-4">
          <div class="mb-3">
            <label class="form-label">Enter OTP</label>
            <div class="d-flex gap-2 align-items-center">
              <input
                id="otp"
                class="form-control"
                inputmode="numeric"
                maxlength="6"
                placeholder="6-digit OTP"
              />
              <button id="verify" type="button" class="btn btn-outline-warning">
                Verify
              </button>
              <span id="tick" class="ok">✓ Verified</span>
            </div>
          </div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" style="display: none" class="mt-4">
          <div class="mb-3">
            <label class="form-label">New mPIN</label>
            <div class="input-group">
              <input
                id="mpin"
                type="password"
                class="form-control"
                inputmode="numeric"
                maxlength="6"
                placeholder="4–6 digits"
              />
              <button
                type="button"
                class="toggle-btn input-group-text"
                data-target="mpin"
              >
                Show
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Confirm mPIN</label>
            <div class="input-group">
              <input
                id="mpin2"
                type="password"
                class="form-control"
                inputmode="numeric"
                maxlength="6"
                placeholder="Repeat mPIN"
              />
              <button
                type="button"
                class="toggle-btn input-group-text"
                data-target="mpin2"
              >
                Show
              </button>
            </div>
          </div>

          <button id="set" type="button" class="btn btn-primary w-100 py-2">
            Reset mPIN
          </button>
        </div>
      </div>
    </div>

    <!-- JS (LOGIC UNCHANGED) -->
    <script>
      const $ = (s) => document.querySelector(s);
      const say = (t) => ($("#msg").textContent = t || "");

      // Toggle show/hide
      document.addEventListener("click", (e) => {
        if (!e.target.classList.contains("toggle-btn")) return;
        const input = document.getElementById(e.target.dataset.target);
        if (!input) return;
        if (input.type === "password") {
          input.type = "text";
          e.target.textContent = "Hide";
        } else {
          input.type = "password";
          e.target.textContent = "Show";
        }
      });

      // STEP 1: Send OTP
      $("#send").onclick = async () => {
        say("");
        const phone = $("#phone").value.trim();
        if (!/^[0-9]{10}$/.test(phone))
          return say("Enter a valid 10-digit phone.");

        try {
          const r = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "send_otp", mobile: phone }),
          });
          const d = await r.json();
          if (!d.success)
            return say(d.error || d.message || "Failed to send OTP.");

          say("OTP sent successfully.");
          $("#step2").style.display = "block";
        } catch (err) {
          console.error(err);
          say("Network error while sending OTP.");
        }
      };

      // STEP 2: Verify OTP
      $("#verify").onclick = async () => {
        say("");
        const phone = $("#phone").value.trim();
        const otp = $("#otp").value.trim();
        if (!/^[0-9]{6}$/.test(otp)) return say("Enter a valid 6-digit OTP.");

        try {
          const v = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              action: "verify_otp",
              mobile: phone,
              otp,
              purpose: "reset",
            }),
          });
          const j = await v.json();
          if (!j.success)
            return say(j.error || j.message || "OTP verification failed.");

          $("#tick").style.display = "inline";
          say("Phone verified. Set your new mPIN.");
          $("#step3").style.display = "block";
        } catch (err) {
          console.error(err);
          say("Network error during OTP verification.");
        }
      };

      // STEP 3: Reset mPIN
      $("#set").onclick = async () => {
        say("");
        const phone = $("#phone").value.trim();
        const mpin = $("#mpin").value.trim();
        const mpin2 = $("#mpin2").value.trim();

        if (!/^[0-9]{4,6}$/.test(mpin)) return say("mPIN must be 4–6 digits.");
        if (mpin !== mpin2) return say("mPINs do not match.");

        try {
          const r = await fetch("/config/reset_mpin.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ phone, mpin }),
          });
          const res = await r.json();
          if (!res.success)
            return say(res.message || res.error || "Failed to reset mPIN.");

          say("mPIN reset successful! Redirecting...");
          setTimeout(() => (window.location = "index.html"), 1200);
        } catch (err) {
          console.error(err);
          say("Network error while resetting mPIN.");
        }
      };
    </script>
  </body>
</html>
