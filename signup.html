<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create an Account</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f5f7fb;
      }
      .auth-card {
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      .ok {
        color: #16a34a;
        font-weight: 600;
        font-size: 0.9rem;
        margin-left: 8px;
      }
      .toggle-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #2563eb;
        font-weight: 500;
        cursor: pointer;
      }
      .input-wrapper {
        position: relative;
      }
      .divider {
        text-align: center;
        margin: 1.5rem 0;
        color: #6b7280;
      }
      .google-btn {
        display: flex;
        justify-content: center;
      }
    </style>
  </head>

  <body>
    <div
      class="container min-vh-100 d-flex align-items-center justify-content-center"
    >
      <div class="row w-100 justify-content-center">
        <div class="col-lg-6 col-md-8">
          <!-- Logo -->
          <div class="text-center mb-4">
            <img
              src="https://www.apnapayment.com/website/img/logo/ApnaPayment200White.png"
              alt="ApnaPayment"
              style="max-width: 180px"
            />
          </div>

          <!-- Card -->
          <div class="card auth-card p-4 p-md-5">
            <form id="signupForm" autocomplete="off">
              <h3 class="text-center fw-bold mb-4">Create an Account</h3>

              <!-- Name -->
              <div class="mb-3">
                <label class="form-label">Full Name</label>
                <input
                  name="name"
                  type="text"
                  class="form-control"
                  required
                  placeholder="Your name"
                />
              </div>

              <!-- Email -->
              <div class="mb-3">
                <label class="form-label">Email</label>
                <div class="d-flex align-items-center">
                  <input
                    name="email"
                    id="emailInput"
                    type="email"
                    class="form-control"
                    required
                    placeholder="you@example.com"
                  />
                </div>
              </div>

              <!-- Phone -->
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <div class="d-flex align-items-center">
                  <input
                    name="phone"
                    id="phoneInput"
                    type="tel"
                    class="form-control"
                    required
                    placeholder="10-digit number"
                  />
                  <span id="phoneTick" class="ok" style="display: none"
                    >✓ Verified</span
                  >
                </div>
              </div>

              <div class="mb-3">
                <button
                  class="btn btn-outline-primary btn-sm"
                  id="sendPhoneOtp"
                  type="button"
                >
                  Send Phone OTP
                </button>
              </div>

              <div
                class="mb-3 d-flex align-items-center gap-2"
                id="phoneOtpRow"
                style="display: none"
              >
                <input
                  id="phoneOtp"
                  class="form-control"
                  inputmode="numeric"
                  maxlength="6"
                  placeholder="6-digit OTP"
                />
                <button
                  class="btn btn-success btn-sm"
                  id="verifyPhoneOtp"
                  type="button"
                >
                  Verify
                </button>
              </div>

              <!-- MPIN -->
              <div class="mb-3">
                <label class="form-label">mPIN</label>
                <div class="input-wrapper">
                  <input
                    name="mpin"
                    id="mpin"
                    type="password"
                    class="form-control"
                    maxlength="6"
                    placeholder="6 digits"
                  />
                  <button type="button" class="toggle-btn" data-target="mpin">
                    Show
                  </button>
                </div>
              </div>

              <div class="mb-4">
                <label class="form-label">Confirm mPIN</label>
                <div class="input-wrapper">
                  <input
                    name="mpin_confirm"
                    id="mpin_confirm"
                    type="password"
                    class="form-control"
                    maxlength="6"
                    placeholder="Repeat mPIN"
                  />
                  <button
                    type="button"
                    class="toggle-btn"
                    data-target="mpin_confirm"
                  >
                    Show
                  </button>
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-100 py-2">
                Sign Up
              </button>

              <div id="msg" class="text-danger text-center mt-3"></div>

              <div class="divider">or</div>

              <div id="google-signup" class="google-btn mb-3"></div>

              <div class="text-center">
                Already have an account?
                <a href="index.html" class="fw-semibold">Sign In</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
      onload="initGoogle()"
    ></script>
    <script src="/public/js/google-auth.js"></script>

    <script>
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const say = (t) => {
        $("#msg").textContent = t || "";
      };

      function normalizePhone(raw) {
        const d = (raw || "").replace(/\D+/g, "");
        return d.length === 10 ? d : "";
      }

      $("#phoneInput").addEventListener("input", () => {
        $("#phoneTick").style.display = "none";
      });

      document.addEventListener("click", (e) => {
        if (!e.target.classList.contains("toggle-btn")) return;
        const targetId = e.target.dataset.target;
        const input = document.getElementById(targetId);
        if (!input) return;
        if (input.type === "password") {
          input.type = "text";
          e.target.textContent = "Hide";
        } else {
          input.type = "password";
          e.target.textContent = "Show";
        }
      });

      async function safeJson(response) {
        const text = await response.text();
        try {
          return { ok: response.ok, json: JSON.parse(text) };
        } catch (e) {
          return { ok: response.ok, json: null, text };
        }
      }

      // ---- Phone OTP send/verify ----
      $("#sendPhoneOtp").onclick = async () => {
        say("");
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        if (!phone) return say("Enter a valid 10-digit phone");
        try {
          const res = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "send_otp", mobile: phone }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(
              parsed.json?.error || parsed.text || "Failed to send phone OTP"
            );
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Failed to send phone OTP");
          $("#phoneOtpRow").style.display = "flex";
          $("#phoneOtp").focus();
        } catch (err) {
          console.error(err);
          say("Network error sending phone OTP");
        }
      };

      $("#verifyPhoneOtp").onclick = async () => {
        say("");
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        const otp = $("#phoneOtp").value.trim();
        if (!/^\d{6}$/.test(otp)) return say("Enter a valid 6-digit OTP");
        try {
          const res = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "verify_otp", mobile: phone, otp }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(
              parsed.json?.error || parsed.text || "Phone OTP verify failed"
            );
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Phone OTP invalid");
          $("#phoneTick").style.display = "inline";
          $("#phoneOtpRow").style.display = "none";
          say("");
        } catch (err) {
          console.error(err);
          say("Network error verifying phone OTP");
        }
      };

      // ---- Signup submit ----
      $("#signupForm").onsubmit = async (e) => {
        e.preventDefault();
        say("");
        const name = document.querySelector("[name=name]").value.trim();
        const email = $("#emailInput").value.trim();
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        const mpin = $("#mpin").value.trim();
        const mpin2 = $("#mpin_confirm").value.trim();

        // Basic client-side checks
        if (!name) return say("Enter your name");
        if (!email) return say("Enter your email");
        if (!phone) return say("Enter a valid 10-digit phone");
        if (!/^\d{4,6}$/.test(mpin)) return say("mPIN must be 4–6 digits");
        if (mpin !== mpin2) return say("mPINs do not match");

        // Ensure OTPs were verified (client-side UI check)
        if (window.getComputedStyle($("#phoneTick")).display === "none")
          return say("Please verify your phone OTP first");

        try {
          const res = await fetch("/config/register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ name, email, phone, mpin }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(parsed.json?.error || parsed.text || "Signup failed");
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Signup failed");
          location.href = "index.html";
        } catch (err) {
          console.error(err);
          say("Network error during signup");
        }
      };
    </script>
  </body>
</html>
