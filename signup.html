<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create an Account</title>
    <link rel="stylesheet" href="/public/css/signup.css" />
  </head>
  <body>
    <div class="auth-layout">
      <div class="nav-logo">
        <img
          src="https://www.apnapayment.com/website/img/logo/ApnaPayment200White.png"
          alt="ApnaPayment"
        />
      </div>
      <div class="form-column">
        <div class="overlay">
          <form id="signupForm" class="auth-card" autocomplete="off">
            <h2 class="header">Create an Account</h2>

            <div class="row">
              <label>Full Name</label>
              <input name="name" type="text" required placeholder="Your name" />
            </div>

            <!-- Email -->
            <div class="row" style="align-items: center">
              <label>Email</label>
              <input
                name="email"
                id="emailInput"
                type="email"
                required
                placeholder="you@example.com"
              />
              <span
                id="emailTick"
                class="ok"
                aria-hidden="true"
                style="display: none"
                >✓ Verified</span
              >
            </div>

            <div class="row">
              <span class="spacer-label"></span>
              <button class="small" id="sendEmailOtp" type="button">
                Send OTP
              </button>
            </div>

            <div
              class="row"
              id="emailOtpRow"
              style="display: none; align-items: center"
            >
              <label>Email OTP</label>
              <input
                id="emailOtp"
                inputmode="numeric"
                maxlength="6"
                pattern="\d{6}"
                placeholder="6-digit code"
              />
              <button class="small" id="verifyEmailOtp" type="button">
                Verify
              </button>
            </div>

            <!-- Phone -->
            <div class="row" style="align-items: center">
              <label>Phone</label>
              <input
                name="phone"
                id="phoneInput"
                type="tel"
                inputmode="numeric"
                maxlength="10"
                pattern="\d{10}"
                required
                placeholder="10-digit number"
              />
              <span
                id="phoneTick"
                class="ok"
                aria-hidden="true"
                style="display: none"
                >✓ Verified</span
              >
            </div>

            <div class="row">
              <span class="spacer-label"></span>
              <button class="small" id="sendPhoneOtp" type="button">
                Send OTP
              </button>
            </div>

            <div
              class="row"
              id="phoneOtpRow"
              style="display: none; align-items: center"
            >
              <label>Phone OTP</label>
              <input
                id="phoneOtp"
                inputmode="numeric"
                maxlength="6"
                pattern="\d{6}"
                placeholder="6-digit code"
              />
              <button class="small" id="verifyPhoneOtp" type="button">
                Verify
              </button>
            </div>

            <!-- mPIN -->
            <div class="row" style="align-items: center">
              <label>mPIN</label>
              <div class="input-wrapper" style="flex: 1">
                <input
                  name="mpin"
                  id="mpin"
                  type="password"
                  inputmode="numeric"
                  maxlength="6"
                  pattern="\d{6}"
                  required
                  placeholder="6 digits"
                />
                <button type="button" class="toggle-btn" data-target="mpin">
                  Show
                </button>
              </div>
            </div>

            <div class="row" style="align-items: center">
              <label>Confirm mPIN</label>
              <div class="input-wrapper" style="flex: 1">
                <input
                  name="mpin_confirm"
                  id="mpin_confirm"
                  type="password"
                  inputmode="numeric"
                  maxlength="6"
                  pattern="\d{6}"
                  required
                  placeholder="Repeat mPIN"
                />
                <button
                  type="button"
                  class="toggle-btn"
                  data-target="mpin_confirm"
                >
                  Show
                </button>
              </div>
            </div>

            <button type="submit">Sign Up</button>
            <div id="msg" class="err" role="status" aria-live="polite"></div>

            <div class="divider">or</div>

            <!-- Google button renders here -->
            <div id="google-signup" class="google-btn"></div>

            <div class="footer-links">
              Already have an account? <a href="index.html">Sign In</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://accounts.google.com/gsi/client"
      async
      defer
      onload="initGoogle()"
    ></script>
    <script src="/public/js/google-auth.js"></script>
    <script>
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const say = (t) => {
        $("#msg").textContent = t || "";
      };

      function normalizePhone(raw) {
        const d = (raw || "").replace(/\D+/g, "");
        return d.length === 10 ? d : "";
      }

      $("#emailInput").addEventListener("input", () => {
        $("#emailTick").style.display = "none";
      });
      $("#phoneInput").addEventListener("input", () => {
        $("#phoneTick").style.display = "none";
      });

      document.addEventListener("click", (e) => {
        if (!e.target.classList.contains("toggle-btn")) return;
        const targetId = e.target.dataset.target;
        const input = document.getElementById(targetId);
        if (!input) return;
        if (input.type === "password") {
          input.type = "text";
          e.target.textContent = "Hide";
        } else {
          input.type = "password";
          e.target.textContent = "Show";
        }
      });

      async function safeJson(response) {
        const text = await response.text();
        try {
          return { ok: response.ok, json: JSON.parse(text) };
        } catch (e) {
          return { ok: response.ok, json: null, text };
        }
      }

      // ---- Email OTP send/verify ----
      $("#sendEmailOtp").onclick = async () => {
        say("");
        const email = $("#emailInput").value.trim();
        if (!email) return say("Enter your email first");
        try {
          const res = await fetch("/config/email_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "send", email }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok) {
            return say(
              parsed.json?.error || parsed.text || "Failed to send email OTP"
            );
          }
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Failed to send email OTP");
          $("#emailOtpRow").style.display = "flex";
          $("#emailOtp").focus();
        } catch (err) {
          console.error(err);
          say("Network error sending email OTP");
        }
      };

      $("#verifyEmailOtp").onclick = async () => {
        say("");
        const email = $("#emailInput").value.trim();
        const code = $("#emailOtp").value.trim();
        if (!/^\d{6}$/.test(code)) return say("Enter a valid 6-digit OTP");
        try {
          const res = await fetch("/config/email_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "verify", email, code }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok) {
            return say(
              parsed.json?.error || parsed.text || "Failed to verify email OTP"
            );
          }
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Email OTP invalid");
          $("#emailTick").style.display = "inline";
          $("#emailOtpRow").style.display = "none";
          say("");
        } catch (err) {
          console.error(err);
          say("Network error verifying email OTP");
        }
      };

      // ---- Phone OTP send/verify ----
      $("#sendPhoneOtp").onclick = async () => {
        say("");
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        if (!phone) return say("Enter a valid 10-digit phone");
        try {
          const res = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "send_otp", mobile: phone }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(
              parsed.json?.error || parsed.text || "Failed to send phone OTP"
            );
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Failed to send phone OTP");
          $("#phoneOtpRow").style.display = "flex";
          $("#phoneOtp").focus();
        } catch (err) {
          console.error(err);
          say("Network error sending phone OTP");
        }
      };

      $("#verifyPhoneOtp").onclick = async () => {
        say("");
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        const otp = $("#phoneOtp").value.trim();
        if (!/^\d{6}$/.test(otp)) return say("Enter a valid 6-digit OTP");
        try {
          const res = await fetch("/config/sms_otp.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ action: "verify_otp", mobile: phone, otp }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(
              parsed.json?.error || parsed.text || "Phone OTP verify failed"
            );
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Phone OTP invalid");
          $("#phoneTick").style.display = "inline";
          $("#phoneOtpRow").style.display = "none";
          say("");
        } catch (err) {
          console.error(err);
          say("Network error verifying phone OTP");
        }
      };

      // ---- Signup submit ----
      $("#signupForm").onsubmit = async (e) => {
        e.preventDefault();
        say("");
        const name = document.querySelector("[name=name]").value.trim();
        const email = $("#emailInput").value.trim();
        const phoneRaw = $("#phoneInput").value.trim();
        const phone = normalizePhone(phoneRaw);
        const mpin = $("#mpin").value.trim();
        const mpin2 = $("#mpin_confirm").value.trim();

        // Basic client-side checks
        if (!name) return say("Enter your name");
        if (!email) return say("Enter your email");
        if (!phone) return say("Enter a valid 10-digit phone");
        if (!/^\d{4,6}$/.test(mpin)) return say("mPIN must be 4–6 digits");
        if (mpin !== mpin2) return say("mPINs do not match");

        // Ensure OTPs were verified (client-side UI check)
        if (window.getComputedStyle($("#emailTick")).display === "none")
          return say("Please verify your email OTP first");
        if (window.getComputedStyle($("#phoneTick")).display === "none")
          return say("Please verify your phone OTP first");

        try {
          const res = await fetch("/config/register.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ name, email, phone, mpin }),
          });
          const parsed = await safeJson(res);
          if (!parsed.ok)
            return say(parsed.json?.error || parsed.text || "Signup failed");
          const d = parsed.json;
          if (!d) return say("Server returned invalid response");
          if (!d.success) return say(d.error || "Signup failed");
          location.href = "index.html";
        } catch (err) {
          console.error(err);
          say("Network error during signup");
        }
      };
    </script>
  </body>
</html>
