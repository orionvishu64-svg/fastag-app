<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create an Account</title>
  <link rel="stylesheet" href="/public/css/signup.css">
  <style>
    .overlay { min-height:100vh; display:grid; place-items:center; padding:24px; }
    .auth-card { max-width:460px; margin:0 auto; }
    .header { text-align:center; margin-bottom:6px; }
    .divider { text-align:center; margin:12px 0; color:#64748b; font-weight:600; }
    .footer-links { margin-top:10px; text-align:center; }
    .spacer-label { width:130px; display:inline-block; }
    .ok { display:none; color:green; margin-left:8px; }
    .err { color:#d93636; margin-top:8px; min-height:18px; }
    .small { padding:8px 12px; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="auth-layout">
    <aside class="info-card" aria-hidden="true">
      <div class="info-inner">
        <h2>Create your account</h2>
        <p class="info-desc">Sign up quickly — we'll verify your phone/email with a one-time code.<br><br>No cards required. Privacy-first. Fast setup.</p>
      </div>
    </aside>

    <div class="form-column">
      <div class="overlay">
        <form id="signupForm" class="auth-card">
          <h2 class="header">Create an Account</h2>

          <div class="row">
            <label style="width:130px">Full Name</label>
            <input name="name" type="text" required placeholder="Your name" />
          </div>

          <!-- Email -->
          <div class="row">
            <label style="width:130px">Email</label>
            <input name="email" type="email" required placeholder="you@example.com" />
            <span id="emailTick" class="ok">✓ Verified</span>
          </div>
          <div class="row">
            <span class="spacer-label"></span>
            <button class="small" id="sendEmailOtp" type="button">Send OTP</button>
          </div>
          <div class="row" id="emailOtpRow" style="display:none">
            <label style="width:130px">Email OTP</label>
            <input required id="emailOtp" inputmode="numeric" maxlength="6" pattern="\d{6}" placeholder="6-digit code" />
            <button class="small" id="verifyEmailOtp" type="button">Verify</button>
          </div>

          <!-- Phone -->
          <div class="row">
            <label style="width:130px">Phone</label>
            <input name="phone" id="phoneInput" inputmode="numeric" maxlength="10" pattern="\d{10}" required placeholder="10-digit number" />
            <span id="phoneTick" class="ok">✓ Verified</span>
          </div>
          <div class="row">
            <span class="spacer-label"></span>
            <button class="small" id="sendPhoneOtp" type="button">Send OTP</button>
          </div>
          <div class="row" id="phoneOtpRow" style="display:none">
            <label style="width:130px">Phone OTP</label>
            <input id="phoneOtp" inputmode="numeric" maxlength="6" pattern="\d{6}" placeholder="6-digit code" required />
            <button class="small" id="verifyPhoneOtp" type="button">Verify</button>
          </div>

          <!-- mPIN -->
          <div class="row">
            <label style="width:130px">mPIN</label>
            <input name="mpin" id="mpin" type="password" inputmode="numeric" maxlength="6" pattern="\d{4,6}" required placeholder="4–6 digits" />
          </div>
          <div class="row">
            <label style="width:130px">Confirm mPIN</label>
            <input name="mpin_confirm" id="mpin_confirm" type="password" inputmode="numeric" maxlength="6" pattern="\d{4,6}" required placeholder="Repeat mPIN" />
          </div>

          <button type="submit">Sign Up</button>
          <div id="msg" class="err"></div>

          <div class="divider">or</div>

          <!-- Google button renders here -->
          <div id="google-signup" class="google-btn"></div>

          <div class="footer-links">
            Already have an account? <a href="index.html">Sign In</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 1) Google library (calls initGoogle when ready) -->
  <script src="https://accounts.google.com/gsi/client" async defer onload="initGoogle()"></script>
  <!-- 2) Your Google logic -->
  <script src="/public/js/google-auth.js"></script>

  <!-- Page logic (OTP + form submit) -->
  <script>
    const $ = s => document.querySelector(s);
    const say = t => $('#msg').textContent = t || '';

    // Hide ticks if user edits after verify
    $('[name=email]').addEventListener('input', () => { $('#emailTick').style.display = 'none'; });
    $('[name=phone]').addEventListener('input', () => { $('#phoneTick').style.display = 'none'; });

    // Email OTP (unchanged)
    $('#sendEmailOtp').onclick = async () => {
      say('');
      const email = $('[name=email]').value.trim();
      if (!email) return say('Enter email first');
      try {
        const r = await fetch('/config/otp_send_email.php', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email }),
          credentials: 'include'
        });
        const d = await r.json();
        if (!d.success) return say(d.error || 'Failed to send email OTP');
        $('#emailOtpRow').style.display = 'flex';
      } catch (err) {
        console.error(err);
        say('Network error sending email OTP');
      }
    };
    $('#verifyEmailOtp').onclick = async () => {
      const email = $('[name=email]').value.trim();
      const code  = $('#emailOtp').value.trim();
      try {
        const r = await fetch('/config/otp_verify_email.php', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, code }),
          credentials: 'include'
        });
        const d = await r.json();
        if (!d.success) return say(d.error || 'Email OTP invalid');
        $('#emailTick').style.display = 'inline';
        $('#emailOtpRow').style.display = 'none';
      } catch (err) {
        console.error(err);
        say('Network error verifying email OTP');
      }
    };

    // PHONE OTP
    // NOTE: updated to match config/sms_otp.php API:
    // - action: 'send_otp' or 'verify_otp'
    // - key name: 'mobile'
    // - include credentials to preserve PHP session cookies
    $('#sendPhoneOtp').onclick = async () => {
      say('');
      const phone = $('#phoneInput').value.trim();
      if (!phone) return say('Enter phone first');
      if (!/^\d{10}$/.test(phone)) return say('Enter 10-digit phone');
      try {
        const r = await fetch('/config/sms_otp.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // important for session storage of OTP
          body: JSON.stringify({ action: 'send_otp', mobile: phone })
        });
        const d = await r.json();
        if (!d.success) return say(d.error || 'Failed to send phone OTP');
        // success
        $('#phoneOtpRow').style.display = 'flex';
        say('OTP sent to ' + phone);
      } catch (err) {
        console.error(err);
        say('Network error sending phone OTP');
      }
    };

    $('#verifyPhoneOtp').onclick = async () => {
      say('');
      const phone = $('#phoneInput').value.trim();
      const code  = $('#phoneOtp').value.trim();
      if (!/^\d{6}$/.test(code)) return say('Enter 6-digit OTP');
      try {
        const r = await fetch('/config/sms_otp.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action: 'verify_otp', mobile: phone, otp: code })
        });
        const d = await r.json();
        if (!d.success) return say(d.error || 'Phone OTP invalid');
        $('#phoneTick').style.display = 'inline';
        $('#phoneOtpRow').style.display = 'none';
        say('Phone verified');
      } catch (err) {
        console.error(err);
        say('Network error verifying phone OTP');
      }
    };

    // Submit signup
    $('#signupForm').onsubmit = async (e) => {
      e.preventDefault(); say('');
      const name  = $('[name=name]').value.trim();
      const email = $('[name=email]').value.trim();
      const phone = $('[name=phone]').value.trim();
      const mpin  = $('#mpin').value.trim();
      const mpin2 = $('#mpin_confirm').value.trim();
      if (!/^\d{4,6}$/.test(mpin)) return say('mPIN must be 4–6 digits');
      if (mpin !== mpin2) return say('mPINs do not match');

      try {
        const r = await fetch('/config/register.php', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials: 'include',
          body: JSON.stringify({ name, email, phone, mpin })
        });
        const d = await r.json();
        if (!d.success) return say(d.error || 'Signup failed');
        location.href = 'index.html';
      } catch (err) {
        console.error(err);
        say('Network error during signup');
      }
    };
  </script>
</body>
</html>
