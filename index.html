<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      html[data-auth-checked="false"] body {
        visibility: hidden;
      }

      body {
        min-height: 100vh;
        background-color: #f4f6f8;
      }

      .auth-card {
        background: #ffffff;
        border-radius: 14px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      }

      .form-label {
        font-weight: 500;
        color: #555;
      }

      .form-control {
        border-radius: 10px;
      }

      .form-control:focus {
        border-color: #ffb84d;
        box-shadow: 0 0 0 0.2rem rgba(255, 184, 77, 0.25);
      }

      .btn-primary {
        background: linear-gradient(90deg, #ffb84d, #e85c41);
        border: none;
        color: #111;
        font-weight: 700;
      }

      .btn-primary:hover {
        filter: brightness(1.05);
      }

      .toggle-btn {
        font-size: 13px;
        color: #e85c41;
        background: none;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
      }

      #msg {
        color: #b00020;
        font-size: 0.9rem;
        min-height: 18px;
      }
    </style>

    <!-- Auth check (UNCHANGED) -->
    <script>
      (function () {
        document.documentElement.setAttribute("data-auth-checked", "false");
        async function reveal() {
          document.documentElement.setAttribute("data-auth-checked", "true");
        }
        (async function () {
          try {
            const res = await fetch("config/check_login.php", {
              credentials: "include",
              cache: "no-store",
            });
            if (res.ok) {
              const j = await res.json();
              if (j && j.logged_in) {
                try {
                  window.dispatchEvent(
                    new CustomEvent("app:login", { detail: j.user }),
                  );
                } catch (e) {}
                const redirectTo = j.partner_required
                  ? "/partner_form.php"
                  : "/dashboard.php";
                window.location.href = redirectTo;
                return;
              }
            }
          } catch (e) {
            console.warn("auth check failed", e);
          }
          reveal();
        })();
      })();
    </script>
  </head>

  <body class="d-flex align-items-center justify-content-center p-3">
    <div class="container" style="max-width: 420px">
      <div class="text-center mb-4">
        <img
          src="https://www.apnapayment.com/website/img/logo/ApnaPayment200Black.png"
          alt="ApnaPayment"
          class="img-fluid"
          style="max-width: 180px"
        />
      </div>

      <div class="auth-card p-4 p-md-5">
        <h4 class="text-center fw-bold mb-4 text-dark">Welcome Back</h4>

        <form id="loginForm" autocomplete="off" novalidate>
          <!-- Phone -->
          <div class="mb-3">
            <label for="phone" class="form-label">Phone</label>
            <input
              id="phone"
              name="phone"
              class="form-control"
              inputmode="numeric"
              pattern="\d{10}"
              maxlength="10"
              placeholder="10-digit phone"
              required
            />
          </div>

          <!-- mPIN -->
          <div class="mb-3">
            <label for="mpin" class="form-label">mPIN</label>
            <div class="input-group">
              <input
                id="mpin"
                name="mpin"
                class="form-control"
                type="password"
                inputmode="numeric"
                maxlength="6"
                pattern="\d{6}"
                placeholder="xxxxxx"
                required
              />
              <button
                type="button"
                class="toggle-btn input-group-text"
                data-target="mpin"
                aria-label="Show mPIN"
              >
                Show
              </button>
            </div>
          </div>

          <button
            id="loginBtn"
            type="submit"
            class="btn btn-primary w-100 py-2"
          >
            Login
          </button>

          <div class="text-end mt-2">
            <a href="forgot-mpin.html" class="small text-decoration-none">
              Forgot your mPIN?
            </a>
          </div>

          <div id="msg" class="mt-2 text-center"></div>

          <div class="text-center mt-3">
            <span class="text-muted">Donâ€™t have an account?</span>
            <a
              href="signup.html"
              class="fw-semibold text-decoration-none"
              style="color: #e85c41"
            >
              Sign Up
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- JS (UNCHANGED LOGIC) -->
    <script>
      const $ = (s) => document.querySelector(s);

      document.addEventListener("click", (e) => {
        if (!e.target.classList.contains("toggle-btn")) return;
        const target = e.target.dataset.target;
        let input = document.getElementById(target);
        if (!input) return;
        if (input.type === "password") {
          input.type = "text";
          e.target.textContent = "Hide";
          e.target.setAttribute("aria-label", "Hide mPIN");
        } else {
          input.type = "password";
          e.target.textContent = "Show";
          e.target.setAttribute("aria-label", "Show mPIN");
        }
      });

      const say = (t) => {
        $("#msg").textContent = t || "";
      };

      $("#loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        say("");

        const phone = ($("#phone").value || "").trim();
        const mpin = ($("#mpin").value || "").trim();

        if (!/^\d{10}$/.test(phone)) return say("Enter 10-digit phone");
        if (!/^\d{4,6}$/.test(mpin)) return say("Invalid mPIN");

        try {
          const r = await fetch("config/login.php", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone, mpin }),
          });

          const text = await r.text();
          let d;
          try {
            d = JSON.parse(text);
          } catch {
            return say("Server error");
          }

          if (!r.ok) {
            return say(d.error || d.message || "Login failed");
          }

          if (
            d.status === "not_registered" ||
            (d.success === false &&
              /not found|agent not found/i.test(d.message || ""))
          ) {
            return window.location.assign(
              "/signup.html?mobile=" + encodeURIComponent(phone),
            );
          }

          if (!d.success) {
            return say(d.error || d.message || "Invalid credentials");
          }

          try {
            window.dispatchEvent(
              new CustomEvent("app:login", { detail: d.user || null }),
            );
          } catch (e) {}

          const redirectTo = d.partner_required
            ? "/partner_form.php"
            : "/dashboard.php";
          window.location.assign(redirectTo);
        } catch (err) {
          console.error(err);
          say("Network error");
        }
      });
    </script>
  </body>
</html>
